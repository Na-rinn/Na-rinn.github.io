import 'package:flutter/material.dart';
import 'package:lolplatform/screen/write_page.dart';
import 'package:lolplatform/screen/setting_page.dart';
import 'package:lolplatform/screen/content_page.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:lolplatform/screen/write_reviews_page.dart';

const Color primaryBlue = Color(0xFF4A90E2); // 파란색
const Color buttonColor = Color(0xFFE5E9F0);

class MatchScreen extends StatefulWidget {
  @override
  _MatchState createState() => _MatchState(); // createState 매서드에서 _MatchState라는 State 객체 생성하여 MatchScreen과 연결
}

class _MatchState extends State<MatchScreen> {
  int _selectedIndex = 0; // 0: 매칭, 1:설정

  // 버튼 빌더 함수
  Widget buildButton(String text, String subtitle, String date, String tier, VoidCallback onPressed) {
    return SizedBox(
      width: double.infinity, // 가로로 꽉 채움
      height: 130,
      child: ElevatedButton(
        onPressed: onPressed,
        style: ButtonStyle(
          backgroundColor: MaterialStateProperty.all(buttonColor),
          overlayColor: MaterialStateProperty.all(Colors.transparent), // 클릭 시 색상 제거
          elevation: MaterialStateProperty.all(0),
          shape: MaterialStateProperty.all(
            RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(15),
              side: const BorderSide(color: Colors.white),
            ),
          ),
          splashFactory: NoSplash.splashFactory, // 리플 효과 제거
        ),

        child: Row(
          children: [
            const SizedBox(width: 10),
            Expanded(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    text,
                    style: const TextStyle(
                      fontSize: 25,
                      color: Colors.black87,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 2),
                  Text(
                    subtitle,
                    style: const TextStyle(fontSize: 13, color: Colors.black54),
                  ),
                  Text(
                    date,
                    style: const TextStyle(fontSize: 13, color: Colors.black54),
                  ),
                ],
              ),
            ),
            const SizedBox (width: 10),
            Container(
              width: 70,
              height: 70,
              decoration: BoxDecoration(
                color: buttonColor,
                borderRadius: BorderRadius.circular(8),
                border: Border.all(color: Colors.black26),
              ),
              alignment: Alignment.center,
              child: Text(
                tier,
                style: const TextStyle(fontSize: 15, fontWeight: FontWeight.bold, color: Colors.black87),
                textAlign: TextAlign.center,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Stream<QuerySnapshot> getMatchesStream() {
    return FirebaseFirestore.instance
        .collection('write')
        .orderBy('createdAt', descending: true)
        .snapshots();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        title: const Text(
          'Match',
          style: TextStyle(color: Colors.black, fontWeight: FontWeight.bold),
        ),
        backgroundColor: Colors.white,
        elevation: 0,
      ),
      body: StreamBuilder<QuerySnapshot>(
        stream: getMatchesStream(),
        builder: (context, snapshot) {
          if (snapshot.hasError) { // 에러 메시지 표시
            return Center(child: Text('오류가 발생했습니다: ${snapshot.error}'));
          }

          if (snapshot.connectionState == ConnectionState.waiting) { // 로딩 화면 표시
            return Center(child: CircularProgressIndicator());
          }

          if (!snapshot.hasData || snapshot.data!.docs.isEmpty) { // hasData가 없으면 "등록된 글이 없습니다"표시
            return Center(child: Text('등록된 글이 없습니다'));
          }

          return SingleChildScrollView(
            padding: const EdgeInsets.all(15.0),
            child: Column(
              children: snapshot.data!.docs.map((doc) {
                // Firestore 문서의 데이터를 Map으로 변환
                Map<String, dynamic> data = doc.data() as Map<String, dynamic>;
                // Firestore에서 positionsDMF List<String>으로 변환
                List<String> positionsList = (data['positions'] as List<dynamic>?) ?.map((e) => e.toString()).toList() ?? [];
                // 부제목 구성
                String subtitle = ''; // 부제목 변수 초기화
                String tier = (data['tier'] != null && data['tier'].toString().isNotEmpty)
                    ? data['tier'] : '무관';
                if (data['type'] != null && data['type'].toString().isNotEmpty) {
                  subtitle += "${data['type']} / ";
                }
                if (positionsList.isEmpty) {
                  subtitle += " / "; // 하나도 선택하지 않은 경우 "미정" 표시
                } else {
                  subtitle  += "${positionsList.join(", ")} / ";
                }
                if (data['people'] != null && data['people'].toString().isNotEmpty) {
                  subtitle +="${data['people']} 모집";
                }
                return Column(
                  children: [
                    buildButton(
                      data['type']?.toString().isNotEmpty == true ? data['type'] : '미정',  // type을 제목으로 사용
                      '${data['mode']?.toString().isNotEmpty == true ? data['mode'] : '미정'} / '
                          '${positionsList.isNotEmpty ? positionsList.join(", ") : '미정'} / '
                          '${data['people']?.toString().isNotEmpty == true ? data['people'] : '미정'}',  // 부제목 수정
                      data['datetime']?.toString().isNotEmpty == true ? data['datetime'] : '미정',
                      tier,
                          () {
                        Navigator.push(
                          context,
                          MaterialPageRoute(
                            builder: (context) => Content(
                              key: UniqueKey(),
                              docId: doc.id, // 글의 문서 Id
                              nickname: "Faker", // Content 페이지에 nickname을 전달
                              rating: "4.3/5.0",
                              type: data['type'] ?? '', //Firestore에서 가져온 게임 타입 전달
                              mode: data['mode'] ?? '',
                              position: positionsList,
                              people: data['people'] ?? '',
                              datetime: data['datetime'] ?? '' ,
                              chatlink: data['chatlink'] ?? '',
                              tier: tier,
                            ),
                          ),
                        );
                      },
                    ),
                    const SizedBox(height: 10),
                  ],
                );
              }).toList(),
            ),
          );
        },
      ),

      floatingActionButton: FloatingActionButton(
        onPressed: () {
          Navigator.push(
            context,
            MaterialPageRoute(builder: (context) => Write()),
          );
        },
        child: const Icon(Icons.add), // 추가 아이콘
        shape: const CircleBorder(),
        elevation: 0,
        highlightElevation: 0,
        backgroundColor: Color(0xFFCFD4DE),
        splashColor: Colors.transparent,
      ),

      floatingActionButtonLocation: FloatingActionButtonLocation.endFloat,
      bottomNavigationBar: BottomNavigationBar(
        backgroundColor: Colors.white,
        currentIndex: _selectedIndex,
        onTap: (index) {
          setState(()=> _selectedIndex=index);
          if (index == 1) {
            Navigator.pushReplacement(
              context,
              MaterialPageRoute(builder: (context) => Setting()),
            );
          }
          if (index == 2) {
            Navigator.pushReplacement(
              context,
              MaterialPageRoute(builder: (context) => ReviewingPage()),
            );
          }
        },
        items: const [
          BottomNavigationBarItem(
            icon: Icon(Icons.people),
            label: '매칭',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.settings),
            label: '설정',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.book),
            label: '리뷰',
          ),
        ],
        selectedItemColor: primaryBlue,
        unselectedItemColor: Colors.black87,
      ),
    );
  }
}
